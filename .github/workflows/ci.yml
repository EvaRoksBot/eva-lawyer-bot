name: CI

on:
  push:
    branches: [main, codex/**]
  pull_request:
    branches: [main]
    types: [opened, synchronize, reopened, ready_for_review]

jobs:
  guard:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Skip if only docs/comments
        run: |
          git fetch --quiet origin
          DIFF=$(git diff --unified=0 --no-color origin/main...HEAD)
          ADDED=$(printf "%s" "$DIFF" | grep -E '^\+[^+]' || true)
          ONLY_DOCS=true
          if git diff --name-only origin/main...HEAD | grep -Ev '\.(md|rst)$' | grep -q . ; then ONLY_DOCS=false; fi
          NON_COMMENT=$(printf "%s" "$ADDED" | grep -Ev '^\+\s*($|#|//|/\*|\*|<!--)' | grep -Ev '^\+\s*\*/\s*$' || true)
          if [[ "$ONLY_DOCS" == true && -z "$NON_COMMENT" ]]; then
            echo "Docs-only change; skip CI."; exit 0
          fi
          echo "Running CI for code changes"
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      - name: Install dependencies
        run: npm ci
      - name: Lint
        run: npm run lint
      - name: Build
        run: npm run build
      - name: Test
        run: npm run test

  security-scan:
    runs-on: ubuntu-latest
    needs: guard
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      - name: Install dependencies
        run: npm ci
      - name: Run security audit
        run: npm audit --audit-level=high
      - name: CodeQL Analysis
        uses: github/codeql-action/analyze@v2
        with:
          languages: javascript
